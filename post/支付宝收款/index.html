<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.65.3" />

  <title>支付宝当面付NodeJS API. &middot; 非常懒</title>

  <meta name="description" content="" />

  
  <meta property="og:locale" content="en-us"/>

  

  
  <meta property="og:site_name" content="非常懒"/>
  <meta property="og:title" content="支付宝当面付NodeJS API."/>
  <meta property="og:description" content="Markdown HTML
https://github.com/Srar/AlipayF2F
AlipayF2F-NodeJS 支付宝当面付NodeJS API. 如何使用 安装方式: npm install alipay-ftof express-example为express的example项目, 您可以将config.js.tpl复制为config.js然后修改好您的当面付配置信息后直接使用.
5分钟快速了解 目前已实现的功能 createQRPay: 预创建二维码支付宝订单, 当扫码后才是真创建订单. verifyCallback: 支付宝回调验签. checkInvoiceStatus: 使用商户订单号查询订单状况. checkInvoiceStatusWithAlipayTradeNo: 使用使用支付宝订单号查询订单状况. refund: 使用商户订单号请求退款操作. (guanbo) refundWithAlipayTradeNo: 使用支付宝订单号请求退款操作. (guanbo) createBarCodePay: 使用支付宝用户付款码付款. (CloudnuY) 屁话多!如何使用? 您先需要准备一个Object对象内部存放alipay的配置如下:
// config.js module.exports = { /* 以下信息可以在https://openhome.alipay.com/platform/appManage.htm查到, 不过merchantPrivateKey需要您自己生成 */ /* 应用AppID */ &#34;appid&#34;: 0, /* 通知URL 接受支付宝异步通知需要用到 */ &#34;notifyUrl&#34;: &#34;&#34;, /* 公钥 和 私钥 的填写方式 */ &#34;testPrivateKey&#34;: &#34;-----BEGIN RSA PRIVATE KEY-----\n&#34; &#43; &#34;公钥或私钥内容...&#34; &#43; &#34;\n-----END RSA PRIVATE KEY-----&#34;, /* 应用RSA私钥 请勿忘记 -----BEGIN RSA PRIVATE KEY----- 与 -----END RSA PRIVATE KEY----- */ &#34;merchantPrivateKey&#34;: &#34;&#34;, /* 支付宝公钥 如果为注释掉会使用沙盒公钥 请勿忘记 -----BEGIN PUBLIC KEY----- 与 -----END PUBLIC KEY----- */ &#34;alipayPublicKey&#34;: &#34;&#34;, /* 支付宝支付网关 如果为注释掉会使用沙盒网关 */ &#34;gatewayUrl&#34;: &#34;&#34;, }; 注意！您需要生成RSA2公钥与私钥来配合本项目使用."/>
  <meta property="og:url" content="https://wfk2022612.github.io/post/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%B6%E6%AC%BE/"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2020-02-25T21:05:57&#43;0800"/>
  <meta property="article:modified_time" content="2020-02-25T21:05:57&#43;0800"/>
  <meta property="article:author" content="">
  
  
  

  <script type="application/ld+json">
  {
    "@context" : "http://schema.org",
    "@type" : "Blog",
    "name": "非常懒",
    "url" : "https://wfk2022612.github.io/",
    "description": ""
  }
  </script>

  
  <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "name": "支付宝当面付NodeJS API.",
    "headline": "支付宝当面付NodeJS API.",
    "datePublished": "2020-02-25T21:05:57\x2b0800",
    "dateModified": "2020-02-25T21:05:57\x2b0800",
    "author": {
      "@type": "Person",
      "name": "",
      "url": "https://wfk2022612.github.io/"
    },
    "url": "https://wfk2022612.github.io/post/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%B6%E6%AC%BE/",
    "description": "Markdown HTML\nhttps:\/\/github.com\/Srar\/AlipayF2F\nAlipayF2F-NodeJS 支付宝当面付NodeJS API. 如何使用 安装方式: npm install alipay-ftof express-example为express的example项目, 您可以将config.js.tpl复制为config.js然后修改好您的当面付配置信息后直接使用.\n5分钟快速了解 目前已实现的功能 createQRPay: 预创建二维码支付宝订单, 当扫码后才是真创建订单. verifyCallback: 支付宝回调验签. checkInvoiceStatus: 使用商户订单号查询订单状况. checkInvoiceStatusWithAlipayTradeNo: 使用使用支付宝订单号查询订单状况. refund: 使用商户订单号请求退款操作. (guanbo) refundWithAlipayTradeNo: 使用支付宝订单号请求退款操作. (guanbo) createBarCodePay: 使用支付宝用户付款码付款. (CloudnuY) 屁话多!如何使用? 您先需要准备一个Object对象内部存放alipay的配置如下:\n\/\/ config.js module.exports = { \/* 以下信息可以在https:\/\/openhome.alipay.com\/platform\/appManage.htm查到, 不过merchantPrivateKey需要您自己生成 *\/ \/* 应用AppID *\/ \x26#34;appid\x26#34;: 0, \/* 通知URL 接受支付宝异步通知需要用到 *\/ \x26#34;notifyUrl\x26#34;: \x26#34;\x26#34;, \/* 公钥 和 私钥 的填写方式 *\/ \x26#34;testPrivateKey\x26#34;: \x26#34;-----BEGIN RSA PRIVATE KEY-----\\n\x26#34; \x2b \x26#34;公钥或私钥内容...\x26#34; \x2b \x26#34;\\n-----END RSA PRIVATE KEY-----\x26#34;, \/* 应用RSA私钥 请勿忘记 -----BEGIN RSA PRIVATE KEY----- 与 -----END RSA PRIVATE KEY----- *\/ \x26#34;merchantPrivateKey\x26#34;: \x26#34;\x26#34;, \/* 支付宝公钥 如果为注释掉会使用沙盒公钥 请勿忘记 -----BEGIN PUBLIC KEY----- 与 -----END PUBLIC KEY----- *\/ \x26#34;alipayPublicKey\x26#34;: \x26#34;\x26#34;, \/* 支付宝支付网关 如果为注释掉会使用沙盒网关 *\/ \x26#34;gatewayUrl\x26#34;: \x26#34;\x26#34;, }; 注意！您需要生成RSA2公钥与私钥来配合本项目使用."
  }
  </script>
  


  <link type="text/css"
        rel="stylesheet"
        href="https://wfk2022612.github.io/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="https://wfk2022612.github.io/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="https://wfk2022612.github.io/css/hyde.css">

  


  <link type="text/css" rel="stylesheet" href="https://wfk2022612.github.io/css/blog.css">

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
      

      <h1>非常懒</h1>

      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://wfk2022612.github.io/">首页</a>
        </li>
        <li>
          <a href="/post/"> 文章 </a>
        </li><li>
          <a href="/about/"> 关于 </a>
        </li>

          
       
      </ul>
    </nav>

    

    <section class="social-icons">
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <h1>支付宝当面付NodeJS API.</h1>

  <div class="post-date">
    <time datetime="2020-02-25T21:05:57&#43;0800">Feb 25, 2020</time> ·
    4 min read
  </div>

  

  <p>Markdown HTML</p>
<p><a href="https://github.com/Srar/AlipayF2F">https://github.com/Srar/AlipayF2F</a></p>
<h1 id="alipayf2f-nodejs">AlipayF2F-NodeJS</h1>
<h2 id="支付宝当面付nodejs-api">支付宝当面付NodeJS API.</h2>
<h2 id="如何使用">如何使用</h2>
<h3 id="安装方式">安装方式:</h3>
<p><code>npm install alipay-ftof</code> 
express-example为express的example项目, 您可以将config.js.tpl复制为config.js然后修改好您的当面付配置信息后直接使用.</p>
<h3 id="5分钟快速了解-目前已实现的功能">5分钟快速了解 目前已实现的功能</h3>
<p>createQRPay: 预创建二维码支付宝订单, 当扫码后才是真创建订单. 
verifyCallback: 支付宝回调验签. 
checkInvoiceStatus: 使用商户订单号查询订单状况. 
checkInvoiceStatusWithAlipayTradeNo: 使用使用支付宝订单号查询订单状况. 
refund: 使用商户订单号请求退款操作.
(guanbo) refundWithAlipayTradeNo: 使用支付宝订单号请求退款操作.
(guanbo) createBarCodePay: 使用支付宝用户付款码付款.
(CloudnuY) 屁话多!如何使用? 
您先需要准备一个Object对象内部存放alipay的配置如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// config.js module.exports = { 
</span><span style="color:#75715e"></span><span style="color:#75715e">/* 以下信息可以在https://openhome.alipay.com/platform/appManage.htm查到, 不过merchantPrivateKey需要您自己生成 */</span> 
<span style="color:#75715e">/* 应用AppID */</span> 
<span style="color:#e6db74">&#34;appid&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, 
<span style="color:#75715e">/* 通知URL 接受支付宝异步通知需要用到 */</span> 
<span style="color:#e6db74">&#34;notifyUrl&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, 
<span style="color:#75715e">/* 公钥 和 私钥 的填写方式 */</span> 
<span style="color:#e6db74">&#34;testPrivateKey&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;-----BEGIN RSA PRIVATE KEY-----\n&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;公钥或私钥内容...&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;\n-----END RSA PRIVATE KEY-----&#34;</span>, 
<span style="color:#75715e">/* 应用RSA私钥 请勿忘记 -----BEGIN RSA PRIVATE KEY----- 与 -----END RSA PRIVATE KEY----- */</span> 
<span style="color:#e6db74">&#34;merchantPrivateKey&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, 
<span style="color:#75715e">/* 支付宝公钥 如果为注释掉会使用沙盒公钥 请勿忘记 -----BEGIN PUBLIC KEY----- 与 -----END PUBLIC KEY----- */</span> 
<span style="color:#e6db74">&#34;alipayPublicKey&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#75715e">/* 支付宝支付网关 如果为注释掉会使用沙盒网关 */</span> 
<span style="color:#e6db74">&#34;gatewayUrl&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, }; 
</code></pre></div><p>注意！您需要生成RSA2公钥与私钥来配合本项目使用. ###预创建订单 new一个alipayf2f对象并将刚刚的config.js传入</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">alipay_f2f</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">alipayf2f</span>(<span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;./config.js&#34;</span>)); 
</code></pre></div><p>然后就能使用createQRPay肛出一个二维码来让用户扫了</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">alipay_f2f</span>.<span style="color:#a6e22e">createQRPay</span>({ 
	<span style="color:#a6e22e">tradeNo</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;123&#34;</span>, <span style="color:#75715e">// 必填 商户订单主键, 就是你要生成的 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">subject</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;女装&#34;</span>, <span style="color:#75715e">// 必填 商品概要 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">totalAmount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0.5</span>, <span style="color:#75715e">// 必填 多少钱 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;黑丝吊带小蜡烛&#34;</span>, <span style="color:#75715e">// 可选 订单描述, 可以对交易或商品进行一个详细地描述，比如填写&#34;购买商品2件共15.00元&#34; 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">timeExpress</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> <span style="color:#75715e">// 可选 支付超时, 默认为5分钟 
</span><span style="color:#75715e"></span>}).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; { 
	<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">result</span>) <span style="color:#75715e">// 支付宝返回的结果 
</span><span style="color:#75715e"></span>}).<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">error</span> =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">error</span>)); 
</code></pre></div><p>如果一切都是理想情况, 支付宝应该会返回code为10000的一段这样JSON:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#e6db74">&#34;code&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;10000&#34;</span>, <span style="color:#e6db74">&#34;msg&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Success&#34;</span>, <span style="color:#e6db74">&#34;out_trade_no&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;123&#34;</span>, <span style="color:#e6db74">&#34;qr_code&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;https://qr.alipay.com/bax09352lmfssonc0gzr0028&#34;</span> } 
</code></pre></div><p>这时您就可以直接把qr_code中的字符串进行二维码化然后直接给用户扫就可以了!</p>
<h3 id="用户扫码并支付-当用户付款后支付宝会发一个post请求到您设置的notifyurl-你要想确认这个回调请求是不是支付宝的该如何判断-不要慌有个方法叫verifycallback就能帮您鉴别是不是支付宝发送的了-假设我们现在使用的是express-并且notifyurl为httpexamplecomcallback">用户扫码并支付 当用户付款后支付宝会发一个post请求到您设置的notifyUrl. 你要想确认这个回调请求是不是支付宝的该如何判断? 不要慌有个方法叫verifyCallback就能帮您鉴别是不是支付宝发送的了! 假设我们现在使用的是express, 并且notifyUrl为http://example.com/callback</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#34;/callback&#34;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; { 
	<span style="color:#75715e">/* 请勿改动支付宝回调过来的post参数, 否则会导致验签失败 */</span> 
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">signStatus</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">alipay_f2f</span>.<span style="color:#a6e22e">verifyCallback</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>); 
	<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">signStatus</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>) { 
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;回调签名验证未通过&#34;</span>); 
	} 
	<span style="color:#75715e">/* 商户订单号 */</span> 
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">noInvoice</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>[<span style="color:#e6db74">&#34;out_trade_no&#34;</span>]; 
	<span style="color:#75715e">/* 订单状态 */</span> 
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">invoiceStatus</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>[<span style="color:#e6db74">&#34;trade_status&#34;</span>]; 
	<span style="color:#75715e">// 支付宝回调通知有多种状态您可以点击已下链接查看支付宝全部通知状态 
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7386797.0.0.aZMdK2&amp;treeId=193&amp;articleId=103296&amp;docType=1#s1 		
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">invoiceStatus</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;TRADE_SUCCESS&#34;</span>) 
	{ 
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#34;success&#34;</span>); 
	} 
	<span style="color:#75715e">/* 一切都验证好后就能更新数据库里数据说用户已经付钱啦 */</span> 	
	<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">noInvoice</span>, { <span style="color:#a6e22e">pay</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> }).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#34;success&#34;</span>)).<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; <span style="color:#a6e22e">res</span>.<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span>)); }); 
</code></pre></div><p>需要注意的是当处理完支付宝回调后应当返回success来告诉支付宝我已经搞定了, 否则支付宝会重复通知防止掉单.</p>
<h3 id="服务器网络暴毙-没收到支付宝回调">服务器网络暴毙? 没收到支付宝回调?</h3>
<p>不要慌我给你实现了一个checkInvoiceStatus方法. 
这个方法呢可以给你手动查询订单状态. 
使用起来也很方便, 只需要传入一个商户订单号就行了:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">	<span style="color:#a6e22e">alipay_f2f</span>.<span style="color:#a6e22e">checkInvoiceStatus</span>(<span style="color:#e6db74">&#34;2333333&#34;</span>)
	.<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; { <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">result</span>); })
	.<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">error</span> =&gt; { }); 
</code></pre></div><p>输出</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ 
	<span style="color:#e6db74">&#34;code&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;10000&#34;</span>, 
	<span style="color:#e6db74">&#34;msg&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Success&#34;</span>, 
	<span style="color:#e6db74">&#34;buyer_logon_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;494***@qq.com&#34;</span>, 
	<span style="color:#e6db74">&#34;buyer_pay_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>, 
	<span style="color:#e6db74">&#34;buyer_user_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0000702210000000&#34;</span>, 
	<span style="color:#e6db74">&#34;fund_bill_list&#34;</span><span style="color:#f92672">:</span>[ { 
		<span style="color:#e6db74">&#34;amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>, 
		<span style="color:#e6db74">&#34;fund_channel&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ALIPAYACCOUNT&#34;</span> 
	} ], 
	<span style="color:#e6db74">&#34;invoice_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>, 
	<span style="color:#e6db74">&#34;open_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;00001023939817879028820892810000&#34;</span>, 
	<span style="color:#e6db74">&#34;out_trade_no&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;alipayf2f_1481800000000&#34;</span>, 
	<span style="color:#e6db74">&#34;point_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.00&#34;</span>, 
	<span style="color:#e6db74">&#34;receipt_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>, 
	<span style="color:#e6db74">&#34;send_pay_date&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2016-12-16 00:00:00&#34;</span>, 
	<span style="color:#e6db74">&#34;total_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>, 
	<span style="color:#e6db74">&#34;trade_no&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2016121621001000000000000000&#34;</span>, 
	<span style="color:#e6db74">&#34;trade_status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;TRADE_SUCCESS&#34;</span> 
} 
</code></pre></div><h3 id="使用用户付款码付款">使用用户付款码付款</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">payment</span> <span style="color:#f92672">=</span> { 
	<span style="color:#75715e">// 商户订单号 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tradeNo</span><span style="color:#f92672">:</span> Date.<span style="color:#a6e22e">now</span>().<span style="color:#a6e22e">toString</span>() <span style="color:#f92672">+</span> Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">9999</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, 
	<span style="color:#75715e">// 订单标题 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">subject</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;女装&#34;</span>, 
	<span style="color:#75715e">// 订单总金额 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">totalAmount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">100</span>, 
	<span style="color:#75715e">// 支付授权码，25~30开头的长度为16~24位的数字，实际字符串长度以开发者获取的付款码长度为准 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">authCode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span> 
} 
</code></pre></div><p>响应</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;10000&#39;</span>, <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Success&#39;</span>, <span style="color:#a6e22e">buyer_logon_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;yqu***@sandbox.com&#39;</span>, <span style="color:#a6e22e">buyer_pay_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>, <span style="color:#a6e22e">buyer_user_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2088102168717885&#39;</span>, <span style="color:#a6e22e">buyer_user_type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PRIVATE&#39;</span>, <span style="color:#a6e22e">fund_bill_list</span><span style="color:#f92672">:</span> [ { <span style="color:#a6e22e">amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>, <span style="color:#a6e22e">fund_channel</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ALIPAYACCOUNT&#39;</span> } ], <span style="color:#a6e22e">gmt_payment</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2017-11-25 14:32:10&#39;</span>, <span style="color:#a6e22e">invoice_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>, <span style="color:#a6e22e">open_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;20880033278643371074141272412388&#39;</span>, <span style="color:#a6e22e">out_trade_no</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;151159149052644861&#39;</span>, <span style="color:#a6e22e">point_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;0.00&#39;</span>, <span style="color:#a6e22e">receipt_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>, <span style="color:#a6e22e">total_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>, <span style="color:#a6e22e">trade_no</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2017112521001004880200394043&#39;</span> } 
</code></pre></div><h3 id="使用商户订单号请求退款">使用商户订单号请求退款</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">refund</span> <span style="color:#f92672">=</span> { <span style="color:#75715e">/* 退款编号 可选 用于分批退款 */</span> <span style="color:#a6e22e">refundNo</span><span style="color:#f92672">:</span> Date.<span style="color:#a6e22e">now</span>(), <span style="color:#75715e">/* 退款金额 如果refundNo为空 refundAmount必须为订单全款 */</span> <span style="color:#a6e22e">refundAmount</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">payment</span>.<span style="color:#a6e22e">totalAmount</span> } <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">alipay_f2f</span>.<span style="color:#a6e22e">refund</span>(<span style="color:#e6db74">&#34;123456&#34;</span>, <span style="color:#a6e22e">refund</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; { <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">have</span>.<span style="color:#a6e22e">property</span>(<span style="color:#e6db74">&#39;code&#39;</span>, <span style="color:#e6db74">&#39;10000&#39;</span>); }); 
</code></pre></div><p>响应</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;10000&#39;</span>, <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Success&#39;</span>, <span style="color:#a6e22e">buyer_logon_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;hya***@sandbox.com&#39;</span>, <span style="color:#a6e22e">buyer_user_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2088102170322284&#39;</span>, <span style="color:#a6e22e">fund_change</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Y&#39;</span>, <span style="color:#a6e22e">gmt_refund_pay</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2017-02-06 17:46:34&#39;</span>, <span style="color:#a6e22e">open_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;20881013820906275677621172812028&#39;</span>, <span style="color:#a6e22e">out_trade_no</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;1486372683551&#39;</span>, <span style="color:#a6e22e">refund_detail_item_list</span><span style="color:#f92672">:</span> [{ <span style="color:#a6e22e">amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>, <span style="color:#a6e22e">fund_channel</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ALIPAYACCOUNT&#39;</span> }], <span style="color:#a6e22e">refund_fee</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>, <span style="color:#a6e22e">send_back_fee</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>, <span style="color:#a6e22e">trade_no</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2017020621001004280200150698&#39;</span> } 
</code></pre></div><h3 id="测试-make-test-测试需要您设置完毕express-exampleconfigjs文件-测试过程中需要人工介入来-生成二维码-">测试 make test 测试需要您设置完毕express-example/config.js文件. 测试过程中需要人工介入来 生成二维码 .</h3>
<p><a href="https://github.com/Srar/AlipayF2F">https://github.com/Srar/AlipayF2F</a></p>
<h1 id="alipayf2f-nodejs-1">AlipayF2F-NodeJS</h1>
<h2 id="支付宝当面付nodejs-api-1">支付宝当面付NodeJS API.</h2>
<h2 id="如何使用-1">如何使用</h2>
<h3 id="安装方式-1">安装方式:</h3>
<pre><code>npm install alipay-ftof
</code></pre><p>express-example为express的example项目, 您可以将config.js.tpl复制为config.js然后修改好您的当面付配置信息后直接使用.</p>
<p>###5分钟快速了解
目前已实现的功能
createQRPay: 预创建二维码支付宝订单, 当扫码后才是真创建订单.
verifyCallback: 支付宝回调验签.
checkInvoiceStatus: 使用商户订单号查询订单状况.
checkInvoiceStatusWithAlipayTradeNo: 使用使用支付宝订单号查询订单状况.
refund: 使用商户订单号请求退款操作.(guanbo)
refundWithAlipayTradeNo: 使用支付宝订单号请求退款操作.(guanbo)
createBarCodePay: 使用支付宝用户付款码付款.(CloudnuY)
屁话多!如何使用?
您先需要准备一个Object对象内部存放alipay的配置如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// config.js
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {

	<span style="color:#75715e">/* 以下信息可以在https://openhome.alipay.com/platform/appManage.htm查到, 不过merchantPrivateKey需要您自己生成 */</span>

	<span style="color:#75715e">/* 应用AppID */</span>
	<span style="color:#e6db74">&#34;appid&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>,

	<span style="color:#75715e">/* 通知URL 接受支付宝异步通知需要用到  */</span>
	<span style="color:#e6db74">&#34;notifyUrl&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,

	<span style="color:#75715e">/* 公钥 和 私钥 的填写方式 */</span>
	<span style="color:#e6db74">&#34;testPrivateKey&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;-----BEGIN RSA PRIVATE KEY-----\n&#34;</span> <span style="color:#f92672">+</span>
		          <span style="color:#e6db74">&#34;公钥或私钥内容...&#34;</span> <span style="color:#f92672">+</span>
		          <span style="color:#e6db74">&#34;\n-----END RSA PRIVATE KEY-----&#34;</span>,

	<span style="color:#75715e">/* 应用RSA私钥 请勿忘记 -----BEGIN RSA PRIVATE KEY----- 与 -----END RSA PRIVATE KEY-----  */</span>
	<span style="color:#e6db74">&#34;merchantPrivateKey&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,

	<span style="color:#75715e">/* 支付宝公钥 如果为注释掉会使用沙盒公钥 请勿忘记 -----BEGIN PUBLIC KEY----- 与 -----END PUBLIC KEY----- */</span>
	<span style="color:#e6db74">&#34;alipayPublicKey&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,

	<span style="color:#75715e">/* 支付宝支付网关 如果为注释掉会使用沙盒网关 */</span>
	<span style="color:#e6db74">&#34;gatewayUrl&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
};
</code></pre></div><p>注意！您需要生成RSA2公钥与私钥来配合本项目使用.</p>
<p>###预创建订单</p>
<p>new一个alipayf2f对象并将刚刚的config.js传入</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">alipay_f2f</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">alipayf2f</span>(<span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;./config.js&#34;</span>));
</code></pre></div><p>然后就能使用createQRPay肛出一个二维码来让用户扫了</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">alipay_f2f</span>.<span style="color:#a6e22e">createQRPay</span>({
    <span style="color:#a6e22e">tradeNo</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;123&#34;</span>,      <span style="color:#75715e">// 必填 商户订单主键, 就是你要生成的
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">subject</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;女装&#34;</span>,      <span style="color:#75715e">// 必填 商品概要
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">totalAmount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0.5</span>,    <span style="color:#75715e">// 必填 多少钱
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;黑丝吊带小蜡烛&#34;</span>, <span style="color:#75715e">// 可选 订单描述, 可以对交易或商品进行一个详细地描述，比如填写&#34;购买商品2件共15.00元&#34;
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">timeExpress</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span>       <span style="color:#75715e">// 可选 支付超时, 默认为5分钟
</span><span style="color:#75715e"></span>}).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">result</span>) <span style="color:#75715e">// 支付宝返回的结果
</span><span style="color:#75715e"></span>}).<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">error</span> =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">error</span>));
</code></pre></div><p>如果一切都是理想情况, 支付宝应该会返回code为10000的一段这样JSON:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
    <span style="color:#e6db74">&#34;code&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;10000&#34;</span>,
    <span style="color:#e6db74">&#34;msg&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Success&#34;</span>,
    <span style="color:#e6db74">&#34;out_trade_no&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;123&#34;</span>,
    <span style="color:#e6db74">&#34;qr_code&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;https://qr.alipay.com/bax09352lmfssonc0gzr0028&#34;</span>
}
</code></pre></div><p>这时您就可以直接把qr_code中的字符串进行二维码化然后直接给用户扫就可以了!</p>
<p>###用户扫码并支付</p>
<p>当用户付款后支付宝会发一个post请求到您设置的notifyUrl.</p>
<p>你要想确认这个回调请求是不是支付宝的该如何判断? 不要慌有个方法叫verifyCallback就能帮您鉴别是不是支付宝发送的了!</p>
<p>假设我们现在使用的是express, 并且notifyUrl为http://example.com/callback</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#34;/callback&#34;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
	<span style="color:#75715e">/* 请勿改动支付宝回调过来的post参数, 否则会导致验签失败 */</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">signStatus</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">alipay_f2f</span>.<span style="color:#a6e22e">verifyCallback</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>);
	<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">signStatus</span> <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>) {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;回调签名验证未通过&#34;</span>);
	}

	<span style="color:#75715e">/* 商户订单号 */</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">noInvoice</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>[<span style="color:#e6db74">&#34;out_trade_no&#34;</span>];
	<span style="color:#75715e">/* 订单状态 */</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">invoiceStatus</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">body</span>[<span style="color:#e6db74">&#34;trade_status&#34;</span>];

	<span style="color:#75715e">// 支付宝回调通知有多种状态您可以点击已下链接查看支付宝全部通知状态
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7386797.0.0.aZMdK2&amp;treeId=193&amp;articleId=103296&amp;docType=1#s1
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">invoiceStatus</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#34;TRADE_SUCCESS&#34;</span>) {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#34;success&#34;</span>);
	}

	<span style="color:#75715e">/* 一切都验证好后就能更新数据库里数据说用户已经付钱啦 */</span>
	<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">update</span>(<span style="color:#a6e22e">noInvoice</span>, { <span style="color:#a6e22e">pay</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> }).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#e6db74">&#34;success&#34;</span>)).<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span> =&gt; <span style="color:#a6e22e">res</span>.<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">err</span>));
});
</code></pre></div><p>需要注意的是当处理完支付宝回调后应当返回success来告诉支付宝我已经搞定了, 否则支付宝会重复通知防止掉单.</p>
<p>###服务器网络暴毙? 没收到支付宝回调?</p>
<p>不要慌我给你实现了一个checkInvoiceStatus方法.</p>
<p>这个方法呢可以给你手动查询订单状态. 使用起来也很方便, 只需要传入一个商户订单号就行了:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">alipay_f2f</span>.<span style="color:#a6e22e">checkInvoiceStatus</span>(<span style="color:#e6db74">&#34;2333333&#34;</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">result</span>);
}).<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">error</span> =&gt; { });
</code></pre></div><p>输出</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
    <span style="color:#e6db74">&#34;code&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;10000&#34;</span>,
    <span style="color:#e6db74">&#34;msg&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;Success&#34;</span>,
    <span style="color:#e6db74">&#34;buyer_logon_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;494***@qq.com&#34;</span>,
    <span style="color:#e6db74">&#34;buyer_pay_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>,
    <span style="color:#e6db74">&#34;buyer_user_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0000702210000000&#34;</span>,
    <span style="color:#e6db74">&#34;fund_bill_list&#34;</span><span style="color:#f92672">:</span>[
        {
            <span style="color:#e6db74">&#34;amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>,
            <span style="color:#e6db74">&#34;fund_channel&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ALIPAYACCOUNT&#34;</span>
        }
    ],
    <span style="color:#e6db74">&#34;invoice_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>,
    <span style="color:#e6db74">&#34;open_id&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;00001023939817879028820892810000&#34;</span>,
    <span style="color:#e6db74">&#34;out_trade_no&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;alipayf2f_1481800000000&#34;</span>,
    <span style="color:#e6db74">&#34;point_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.00&#34;</span>,
    <span style="color:#e6db74">&#34;receipt_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>,
    <span style="color:#e6db74">&#34;send_pay_date&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2016-12-16 00:00:00&#34;</span>,
    <span style="color:#e6db74">&#34;total_amount&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0.01&#34;</span>,
    <span style="color:#e6db74">&#34;trade_no&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2016121621001000000000000000&#34;</span>,
    <span style="color:#e6db74">&#34;trade_status&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;TRADE_SUCCESS&#34;</span>
}
</code></pre></div><p>###使用用户付款码付款</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">payment</span> <span style="color:#f92672">=</span> {
    <span style="color:#75715e">// 商户订单号
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">tradeNo</span><span style="color:#f92672">:</span> Date.<span style="color:#a6e22e">now</span>().<span style="color:#a6e22e">toString</span>() <span style="color:#f92672">+</span> Math.<span style="color:#a6e22e">floor</span>(Math.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">*</span> <span style="color:#ae81ff">9999</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
    <span style="color:#75715e">// 订单标题
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">subject</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;女装&#34;</span>,
    <span style="color:#75715e">// 订单总金额
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">totalAmount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">100</span>,
    <span style="color:#75715e">// 支付授权码，25~30开头的长度为16~24位的数字，实际字符串长度以开发者获取的付款码长度为准
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">authCode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
}
</code></pre></div><p>响应</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{ 
    <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;10000&#39;</span>,
    <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Success&#39;</span>,
    <span style="color:#a6e22e">buyer_logon_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;yqu***@sandbox.com&#39;</span>,
    <span style="color:#a6e22e">buyer_pay_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>,
    <span style="color:#a6e22e">buyer_user_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2088102168717885&#39;</span>,
    <span style="color:#a6e22e">buyer_user_type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PRIVATE&#39;</span>,
    <span style="color:#a6e22e">fund_bill_list</span><span style="color:#f92672">:</span> [ { <span style="color:#a6e22e">amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>, <span style="color:#a6e22e">fund_channel</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ALIPAYACCOUNT&#39;</span> } ],
    <span style="color:#a6e22e">gmt_payment</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2017-11-25 14:32:10&#39;</span>,
    <span style="color:#a6e22e">invoice_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>,
    <span style="color:#a6e22e">open_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;20880033278643371074141272412388&#39;</span>,
    <span style="color:#a6e22e">out_trade_no</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;151159149052644861&#39;</span>,
    <span style="color:#a6e22e">point_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;0.00&#39;</span>,
    <span style="color:#a6e22e">receipt_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>,
    <span style="color:#a6e22e">total_amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>,
    <span style="color:#a6e22e">trade_no</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2017112521001004880200394043&#39;</span> 
}
</code></pre></div><p>###使用商户订单号请求退款</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">refund</span> <span style="color:#f92672">=</span> {
  <span style="color:#75715e">/* 退款编号 可选 用于分批退款 */</span>
  <span style="color:#a6e22e">refundNo</span><span style="color:#f92672">:</span> Date.<span style="color:#a6e22e">now</span>(),
  <span style="color:#75715e">/* 退款金额 如果refundNo为空 refundAmount必须为订单全款 */</span>
  <span style="color:#a6e22e">refundAmount</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">payment</span>.<span style="color:#a6e22e">totalAmount</span>
}
<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">alipay_f2f</span>.<span style="color:#a6e22e">refund</span>(<span style="color:#e6db74">&#34;123456&#34;</span>, <span style="color:#a6e22e">refund</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">result</span> =&gt; {
  <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">should</span>.<span style="color:#a6e22e">have</span>.<span style="color:#a6e22e">property</span>(<span style="color:#e6db74">&#39;code&#39;</span>, <span style="color:#e6db74">&#39;10000&#39;</span>);
});
</code></pre></div><p>响应</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript">{
  <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;10000&#39;</span>,
  <span style="color:#a6e22e">msg</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Success&#39;</span>,
  <span style="color:#a6e22e">buyer_logon_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;hya***@sandbox.com&#39;</span>,
  <span style="color:#a6e22e">buyer_user_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2088102170322284&#39;</span>,
  <span style="color:#a6e22e">fund_change</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Y&#39;</span>,
  <span style="color:#a6e22e">gmt_refund_pay</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2017-02-06 17:46:34&#39;</span>,
  <span style="color:#a6e22e">open_id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;20881013820906275677621172812028&#39;</span>,
  <span style="color:#a6e22e">out_trade_no</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;1486372683551&#39;</span>,
  <span style="color:#a6e22e">refund_detail_item_list</span><span style="color:#f92672">:</span> [{
    <span style="color:#a6e22e">amount</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>,
    <span style="color:#a6e22e">fund_channel</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;ALIPAYACCOUNT&#39;</span>
  }],
  <span style="color:#a6e22e">refund_fee</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>,
  <span style="color:#a6e22e">send_back_fee</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;100.00&#39;</span>,
  <span style="color:#a6e22e">trade_no</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;2017020621001004280200150698&#39;</span>
}
</code></pre></div><p>###测试
make test
测试需要您设置完毕express-example/config.js文件. 测试过程中需要人工介入来 生成二维码 .
<!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->


  
  <ul class="article-tags">
    
    <li> <a href="https://wfk2022612.github.io/tags/%E6%94%AF%E4%BB%98%E5%AE%9D/">支付宝</a> </li>
    
    <li> <a href="https://wfk2022612.github.io/tags/nodejs/">nodejs</a> </li>
    
  </ul>
  
  
   
  <div id="git-comments"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
    var gitment = new Gitment({
      id: '',  
      owner: 'wfk2022612',
      repo: 'wfk2022612/wfk2022612.github.io',
      oauth: {
        client_id: '3d3e2c1bb7f7fec9066c',
        client_secret: '951c10b1f308db23d76aab7693087a5c9b6a2309',
      }
    })
    gitment.render('git-comments')
  </script>
   
</div>


  </main>

  <footer>
  <div class="copyright">
    &copy; 非常懒 2020 · <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>

  <script src="https://wfk2022612.github.io/js/blog.js"></script>

  
</body>
</html>
